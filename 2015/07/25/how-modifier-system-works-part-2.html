<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Learn how Blender's modifier system works (part 2) &middot; Learn Blender Development
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/poole.css">
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/syntax.css">
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/learnblenderdev-site/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/learnblenderdev-site/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- MathJax -->
  
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>This ia a blog on Blender scripting and extending.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/learnblenderdev-site/">Home</a>

    

    
    
      
        
          <a class="sidebar-nav-item" href="/learnblenderdev-site/about/">About</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/learnblenderdev-site/tags/">Tags</a>
        
      
    

    <!--
    <a class="sidebar-nav-item" href="/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    -->
    <span class="sidebar-nav-item">Latest update: 2015-07-25 23:10:10 +0800</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/learnblenderdev-site/" title="Home">Learn Blender Development</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Learn how Blender's modifier system works (part 2)</h1>
  <span class="post-date">25 Jul 2015</span>
  <p>We have learned how a modifier is constructed
in the <a href="/learnblenderdev-site/2015/07/23/how-modifier-system-works-part-1.html">previous post</a>.</p>

<p>In this post we will learn how a modifier is applied.</p>

<p>We have already known that a modifier defines a derived <code>ModifierTypeInfo</code> structure.
Take <code>Array</code> modifier as an example, its <code>ModifierTypeInfo</code> is defined
in the file <code>source/blender/modifiers/intern/MOD_array.c</code>.</p>

<p>The <code>applyModifier</code> function in <code>ModifierTypeInfo</code> seems to be the place where actual modifier execution happens.
We can set a break point in it and do some tracing.</p>

<p>Following is a call stack for the <code>applyModifier</code> function:</p>

<pre><code>arrayModifier_doArray(ArrayModifierData * amd, Scene * scene, Object * ob, DerivedMesh * dm, ModifierApplyFlag flag)
applyModifier(ModifierData * md, Object * ob, DerivedMesh * dm, ModifierApplyFlag flag)
modwrap_applyModifier(ModifierData * md, Object * ob, DerivedMesh * dm, ModifierApplyFlag flag)
mesh_calc_modifiers(Scene * scene, Object * ob, float[3] * inputVertexCos, DerivedMesh * * deform_r, DerivedMesh * * final_r, int useRenderParams, int useDeform, int needMapping, unsigned __int64 dataMask, int index, int useCache, int build_shapekey_layers)
mesh_build_data(Scene * scene, Object * ob, unsigned __int64 dataMask, int build_shapekey_layers, int needMapping)
makeDerivedMesh(Scene * scene, Object * ob, BMEditMesh * em, unsigned __int64 dataMask, int build_shapekey_layers)
BKE_object_handle_data_update(EvaluationContext * eval_ctx, Scene * scene, Object * ob)
BKE_object_handle_update_ex(EvaluationContext * eval_ctx, Scene * scene, Object * ob, RigidBodyWorld * rbw, const bool do_proxy_update)
scene_update_object_func(TaskPool * pool, void * taskdata, int threadid)
BLI_task_pool_work_and_wait(TaskPool * pool)
scene_update_objects(EvaluationContext * eval_ctx, Main * bmain, Scene * scene, Scene * scene_parent)
scene_update_tagged_recursive(EvaluationContext * eval_ctx, Main * bmain, Scene * scene, Scene * scene_parent)
BKE_scene_update_tagged(EvaluationContext * eval_ctx, Main * bmain, Scene * scene)
wm_event_do_notifiers(bContext * C)
WM_main(bContext * C)
main(int argc, const unsigned char * * UNUSED_argv_c)
</code></pre>

<p>In the function <code>mesh_calc_modifiers</code> we see a loop through all modifiers:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">for</span> <span class="p">(;</span> <span class="n">md</span><span class="p">;</span> <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">ndm</span> <span class="o">=</span> <span class="n">modwrap_applyModifier</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">app_flags</span><span class="p">);</span>
    <span class="n">ASSERT_IS_VALID_DM</span><span class="p">(</span><span class="n">ndm</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ndm</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* if the modifier returned a new dm, release the old one */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dm</span> <span class="o">&amp;&amp;</span> <span class="n">dm</span> <span class="o">!=</span> <span class="n">ndm</span><span class="p">)</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>

        <span class="n">dm</span> <span class="o">=</span> <span class="n">ndm</span><span class="p">;</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span></code></pre></div>

<p>Inside this loop each modifier gets executed in <code>modwrap_applyModifier</code> function.</p>

<p>We notice that a <code>DerivedMesh</code>(file <code>source/blender/blenkernel/BKE_DerivedMesh.h</code>) object(variable <code>dm</code> in the code) is passed to the modifier
and then another <code>DerivedMesh</code> object(variable <code>ndm</code> in the code) is returned back to the caller.
We can then conclude that the <code>DerivedMesh</code> is the media that gets passed through modifier stack.
<a href="http://wiki.blender.org/index.php/Dev:Source/Modeling/DerivedMesh">Here</a> is the document for <code>Derivedmesh</code>.</p>

<p>Also note that the caller of a modifier always <em>own</em> the <code>DerivedMesh</code> object.
If we construct a new <code>DerivedMesh</code> in our modifier like what the <code>Array</code> modifier does,
the new derived mesh will be <em>moved</em> to the caller, and the old one will be released.</p>

<p>Now we go back to the function <code>arrayModifier_doArray</code>, where actual modifier action happens.
This is a long function. I try to provide an overview of what it does.</p>

<p>In the beginning of <code>arrayModifier_doArray</code> it collects options and parameters from the <code>ArrayModifierData</code>(variable <code>amd</code> in following source code).
For example:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">const</span> <span class="kt">bool</span> <span class="n">use_merge</span> <span class="o">=</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MOD_ARR_MERGE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">const</span> <span class="kt">bool</span> <span class="n">use_offset_ob</span> <span class="o">=</span> <span class="p">((</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">offset_type</span> <span class="o">&amp;</span> <span class="n">MOD_ARR_OFF_OBJ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">offset_ob</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span></code></pre></div>

<p>Then it reads in the <code>DerivedMesh</code> which is passed from previous modifier in the modifier stack:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">chunk_nverts</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">getNumVerts</span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
<span class="n">chunk_nedges</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">getNumEdges</span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
<span class="n">chunk_nloops</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">getNumLoops</span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
<span class="n">chunk_npolys</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">getNumPolys</span><span class="p">(</span><span class="n">dm</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="n">src_mvert</span> <span class="o">=</span> <span class="n">dm</span><span class="o">-&gt;</span><span class="n">getVertArray</span><span class="p">(</span><span class="n">dm</span><span class="p">);</span></code></pre></div>

<p>After all information has been ready, a new derived mesh will be constructed:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">result</span> <span class="o">=</span> <span class="n">CDDM_from_template</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">result_nverts</span><span class="p">,</span> <span class="n">result_nedges</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result_nloops</span><span class="p">,</span> <span class="n">result_npolys</span><span class="p">);</span></code></pre></div>

<p>Then we can write to this new derived mesh:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cm">/* copy customdata to original geometry */</span>
<span class="n">DM_copy_vert_data</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chunk_nverts</span><span class="p">);</span>
<span class="n">DM_copy_edge_data</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chunk_nedges</span><span class="p">);</span>
<span class="n">DM_copy_loop_data</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chunk_nloops</span><span class="p">);</span>
<span class="n">DM_copy_poly_data</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chunk_npolys</span><span class="p">);</span>
<span class="c1">// ...</span></code></pre></div>

<p>Finally the modifier finishes by returning the new derived mesh: <code>return result;</code>.</p>

<p>Now we have learned almost all about Blender modifier system,
except that the dependency graph related functions in a modifier implementation.
I leave these things to future posts.</p>


  <hr>
  
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'learnblenderdev';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/25/update-site-appearance.html">
            Update site's appearance
            <small>25 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/25/fix-meshgrid-indexing-in-3d-dual-contouring.html">
            Fix mesh grid indexing in 3D dual contouring
            <small>25 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/24/preliminary-3d-dual-contouring.html">
            Preliminary 3D dual contouring
            <small>24 Jul 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
