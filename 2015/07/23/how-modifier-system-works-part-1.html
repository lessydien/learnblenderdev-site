<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Learn how Blender's modifier system works (part 1) &middot; Learn Blender Development
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/poole.css">
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/syntax.css">
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/learnblenderdev-site/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/learnblenderdev-site/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- MathJax -->
  
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>This ia a blog on Blender scripting and extending.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/learnblenderdev-site/">Home</a>

    

    
    
      
        
          <a class="sidebar-nav-item" href="/learnblenderdev-site/about/">About</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/learnblenderdev-site/tags/">Tags</a>
        
      
    

    <!--
    <a class="sidebar-nav-item" href="/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    -->
    <span class="sidebar-nav-item">Latest update: 2015-07-25 22:48:56 +0800</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/learnblenderdev-site/" title="Home">Learn Blender Development</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Learn how Blender's modifier system works (part 1)</h1>
  <span class="post-date">23 Jul 2015</span>
  <p>In this and following several posts I will write about Blender’s modifier system.
I expect following questions to be answered:</p>

<ol>
  <li>How is modifiers’ source code organized in the source tree?</li>
  <li>How is a modifier registered to Blender system?</li>
  <li>Where and when does a modifier operate?</li>
  <li>How are modifiers combined together?</li>
</ol>

<p>It seems that the last question is too broad. Let me elaborate to make it more specific.</p>

<p>As you know, Blender organizes all modifiers in a stack.
Then multiple modifiers can be combined and chained together.
Two adjacent modifiers in the stack must agree in a data format
so that the processed data from previous modifier can be handed over
to the next one.
So what is the protocol of data format which is used among different modifiers?</p>

<p>Now let us get started with above questions in mind.</p>

<p>First we start with the function where a modifier is added to an object.
Hover the cursor on the <code>Array</code> modifier icon from the <code>Add Modifier</code> menu in the modifiers panel,
you can see the Python code in the pop-up: <code>bpy.ops.object.modifier_add(type="ARRAY")</code>.
This is an operator named <code>modifier_add</code>.
Search this name in the source code you will find the operator registration function <code>OBJECT_OT_modifier_add</code>.
And then you can locate the actual execution function of this operator: <code>modifier_add_exec</code>(file <code>source/blender/editors/object/object_modifier.c</code>).
We add a break point in <code>modifier_add_exec</code> to trace the construction of a modifier.</p>

<p>Now we try to add an <code>Array</code> modifier and step into the <code>ED_object_modifier_add</code> from <code>modifier_add_exec</code>.</p>

<p>In <code>ED_object_modifier_add</code>,</p>

<ol>
  <li>
    <p>Information of a modifier is retrieved by calling function
<code>modifierType_getInfo</code>(file <code>source/blender/blenkernel/intern/modifier.c</code>)
on a given <code>ModifierType</code>(file <code>source/blender/makesdna/DNA_modifier_types.h</code>).
This information is stored in <code>struct ModifierTypeInfo</code>(file <code>source/blender/blenkernel/BKE_modifier.h</code>).
You can register your own modifiers by providing informations for them in this file.</p>
  </li>
  <li>
    <p>A new modifier is constructed in function <code>modifier_new</code>(file <code>source/blender/blenkernel/intern/modifier.c</code>).
In this function, a <code>ModifierData</code> structure(file ‘source/blender/makesdna/DNA_modifier_types.h’) is allocated
through <code>MEM_callocN(mti-&gt;structSize, mti-&gt;structName)</code>.</p>

    <p>Note that a “derived” <code>ModifierData</code> is actually allocated here.
The allocator uses a structure size recored in <code>ModifierTypeInfo</code>(<code>mti</code> variable in the code), which usually is different from <code>ModifierData</code>’s.</p>

    <p>For ‘Array’ modifier, we can see it is <code>ArrayModifierData</code>,
which is defined in the file <code>source/blender/makesdna/DNA_modifier_types.h</code>.</p>

    <p>After that, the modifier gets initialized through <code>if (mti-&gt;initData) mti-&gt;initData(md);</code>.</p>

    <p>The function <code>initData</code> is a function pointer you could set in the <code>ModifierTypeInfo</code> structure.
By stepping into this function you can reach the definition of <code>Array</code> modifier’s initializer,
which resides in the file <code>source/blender/modifiers/intern/MOD_array.c</code>.
During the initialization stage, one modifier’s “derived” <code>ModifierData</code> is initialized.</p>

    <p>In the file <code>MOD_array.c</code> there are also many other functions.
These functions could be set to the <code>ModifierTypeInfo</code> structure when you define the modifier.</p>

    <p>Along with the file <code>MOD_array.c</code> there are many other files with a prefix of <code>MOD_</code>.
These are the sources of other modifiers. They reside in the folder <code>source/blender/modifiers/intern</code>.</p>
  </li>
</ol>

<p>Speak in the Object-Oriented glossary,
the <code>ModifierTypeInfo</code> is the common interface that modifiers should derive from.</p>

<p>Now the definition and construction of a modifier are finished.</p>

<p>In the next part I will dive into the execution code of the <code>Array</code> modifier.</p>


  <hr>
  
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'learnblenderdev';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/25/update-site-appearance.html">
            Update site's appearance
            <small>25 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/25/fix-meshgrid-indexing-in-3d-dual-contouring.html">
            Fix mesh grid indexing in 3D dual contouring
            <small>25 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/25/how-modifier-system-works-part-2.html">
            Learn how Blender's modifier system works (part 2)
            <small>25 Jul 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
