<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Construct BMesh from Mesh &middot; Learn Blender Development
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/poole.css">
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/syntax.css">
  <link rel="stylesheet" href="/learnblenderdev-site/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/learnblenderdev-site/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/learnblenderdev-site/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- MathJax -->
  
</head>


  <body class="layout-reverse sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>This ia a blog on Blender scripting and extending.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/learnblenderdev-site/">Home</a>

    

    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/learnblenderdev-site/about/">About</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/learnblenderdev-site/tags/">Tags</a>
        
      
    

    <!--
    <a class="sidebar-nav-item" href="/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    -->
    <span class="sidebar-nav-item">Latest update: 2015-07-25 21:29:17 +0800</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/learnblenderdev-site/" title="Home">Learn Blender Development</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Construct BMesh from Mesh</h1>
  <span class="post-date">05 Apr 2015</span>
  <p>(<strong>WARNING</strong>
The implementation of this operator
is based on an inspection of Blender source code.
It just works but does not reflect
the suggested usage from the design.)</p>

<p>In this post I will take an experiment
on generating mesh dynamically in Blender.</p>

<p>As I said in the <a href="/learnblenderdev-site/2015/04/01/analyze-primitive-cube-add-operator.html">previous post</a>
there are two possible approaches to generate mesh data dynamically.
One is to add a new BMesh operator which is similar to <code>create_cube</code>.
The other is
to construct a <code>Mesh</code>(defined in the file <code>DNA_mesh_types.h</code>) first
and apply the BMesh operator <code>mesh_to_bmesh</code>.
I will try the later one today.</p>

<p>The major problem of this project is how to construct a <code>Mesh</code>.
More concretely, you have to search for functions
which can be used as tools to construct a <code>Mesh</code>.</p>

<p>If you are familiar with the <a href="http://wiki.blender.org/index.php/Dev:2.5/Doc/Blender_Source/Files_structure">directory structure</a> of Blender,
you would probably make a correct guess that those <code>Mesh</code> related functions
should be in <code>blender/source/blender/editors/</code>(The answer is <code>ED_mesh.h</code>).
But you still have to spend time on making sure your way of
applying those functions is correct,
that is, you should provide the correct preconditions for every call.</p>

<p>Instead of the above approach,
I introduce you a way to learn how to construct a <code>Mesh</code>
by using Blenderâ€™s Python API.</p>

<p>Let us get started.</p>

<p>I assume you are familiar of how to achieve this using Python API:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">mesh</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meshes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;MyMesh&quot;</span><span class="p">)</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">faces</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">from_pydata</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="p">[],</span> <span class="n">faces</span><span class="p">)</span></code></pre></div>

<p>The most important function is <code>from_pydata</code>.
This function fills the mesh data and build the topology for a mesh.
You can find the implementation of this function
in file <code>bpy_types.py</code>(directory <code>blender/release/scripts/modules</code>).</p>

<p>I put an excerpt of its source code below:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">)))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="p">))</span>

<span class="n">vertices_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">foreach_set</span><span class="p">(</span><span class="s">&quot;co&quot;</span><span class="p">,</span> <span class="n">vertices_flat</span><span class="p">)</span>
<span class="k">del</span> <span class="n">vertices_flat</span>

<span class="n">edges_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">foreach_set</span><span class="p">(</span><span class="s">&quot;vertices&quot;</span><span class="p">,</span> <span class="n">edges_flat</span><span class="p">)</span>
<span class="k">del</span> <span class="n">edges_flat</span>

<span class="c"># this is different in bmesh</span>
<span class="n">loop_index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">faces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">loop_start</span> <span class="o">=</span> <span class="n">loop_index</span>
    <span class="n">p</span><span class="o">.</span><span class="n">loop_total</span> <span class="o">=</span> <span class="n">loop_len</span>
    <span class="n">p</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">f</span>
    <span class="n">loop_index</span> <span class="o">+=</span> <span class="n">loop_len</span>

<span class="c"># if no edges - calculate them</span>
<span class="k">if</span> <span class="n">faces</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">edges</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">calc_edges</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>

<p>All functions called above is implemented in C.
By applying tracing techniques I introduced in
<a href="/learnblenderdev-site/2015/03/20/tips-on-tracing-blender-system.html">this post</a>
(Hint: search <code>"add"</code>, <code>"loop_start"</code> in the source code.
Be sure to include the double quotes while searching
since we are interested in the reflection code with those words),
we can collect all of the information we need to construct a <code>Mesh</code>.</p>

<p>After that, the remains are simple.</p>

<p>To call a BMesh operator, according our
<a href="/learnblenderdev-site/2015/04/01/analyze-primitive-cube-add-operator.html">analysis</a>
on BMesh system,
you can find the desired operator name and parameters in <code>bmo_opdefines</code>.</p>

<p>Also do not forget to link the newly created object to the scene,
and trigger a notification.</p>

<p>I upload all source code of this experiment
<a href="https://github.com/thebusytypist/BlenderExtraOperators/tree/master/CreateBMeshFromMesh">here</a>.</p>

<p>In the next post I will write some real code on the contouring algorithm.</p>


  <hr>
  
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'learnblenderdev';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/25/fix-meshgrid-indexing-in-3d-dual-contouring.html">
            Fix mesh grid indexing in 3D dual contouring
            <small>25 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/25/how-modifier-system-works-part-2.html">
            Learn how Blender's modifier system works (part 2)
            <small>25 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/learnblenderdev-site/2015/07/24/preliminary-3d-dual-contouring.html">
            Preliminary 3D dual contouring
            <small>24 Jul 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
